<HTML>
<HEAD>
<link rel="stylesheet" type="text/css" href="style.css">
<SCRIPT>

	function addcontroller() {
		node = document.createElement("IFRAME");
		node.setAttribute("frameborder", "0" );
		node.setAttribute("width", "100%" );
		node.setAttribute("scrolling", "no" );
		node.setAttribute("name", this.responseURL );
		node.setAttribute("src", "subframe.html?arg=" + this.responseURL );

		var div = document.getElementById("controllers");
		var list = Array.from( div.childNodes );
		list.push( node );
	
		list.sort(	function( a,b ) {
						if ( a.src > b.src ) return -1;
						return 1;
					} );

		while ( child = div.firstChild ) child.remove();
		list.forEach( function(e) { div.insertBefore( e, div.firstChild ); } );
	}

	function update( url ) {
		list = Array.from( document.getElementById("controllers").getElementsByTagName("iframe") );
		list.forEach(	function(e) {
							source = e.getAttribute("src").split('?')[1];
							if ( source == url ) {
								h = e.contentDocument.body.scrollHeight;
								e.height = h;
							}
						} );
	}

	function main() {
		for ( i = 1; i < 3; i++ ) {
			name = "http://" + window.location.hostname + ":" + (32700+i) + "/data";
			var req = new XMLHttpRequest();
			req.addEventListener( "load", addcontroller );
			req.open( "GET", name );
			req.send();
		}

		window.addEventListener( 'message', function(p) { update(p.data); }, false );

		doTotals();
	}

	function doTotals() {
		console.log("updating totals");
		list = Array.from( document.getElementById("controllers").getElementsByTagName("iframe") );
		var total = 0.0
		list.forEach(	function(e) {
							arr = e.contentDocument.getElementById("now_power");
							if ( arr.innerHTML ) {
								power = parseFloat( arr.innerHTML.split(' ')[0] );
								total += power;
							}
						} );
		total = total.toFixed(2);

		document.getElementById("total_power").innerHTML = "Total PV Power " + total + " KwH";

		window.setTimeout( "doTotals();", 1234 );
	}
	
</SCRIPT>
</HEAD>
<BODY onload="main();">
	<H1>Solar Farm Status</H1>
	<HR>
	<DIV ID="controllers"></DIV>
	<HR>
	<H2 ID="total_power"></H2>
</BODY>
</HTML>

